## Database > RDS for MS-SQL > バックアップおよび復元

## バックアップ

DBインスタンスのデータベースを復旧できるように、事前に準備できます。RDS for MS-SQLは、データベースごとに順次バックアップを行います。
任意のタイミングで手動でバックアップを作成したり、バックアップ保管期間を設定して自動的にバックアップを作成できます。
手動で作成したバックアップを利用して特定時刻へ復元したり、バックアップ保管期間中の任意の時点へ復元ができます。

> [注意]
> バックアップの実行中は、バックアップによる性能の低下が発生する場合があります。
> サービスに影響を与えないよう、サービスの負荷が小さい時間にバックアップを行うことを推奨します。

### バックアップストレージ

RDS for SQL Serverは、すべてのバックアップファイルを別のオブジェクトストレージに保存します。
自動バックアップファイルは、DBインスタンスを削除すると全て削除され、手動バックアップファイルはユーザーが削除しない限りオブジェクトストレージに永続的に保存されます。

### 自動バックアップ

DBインスタンスのバックアップ保管期間を1日以上に設定すると、自動バックアップが有効になり、指定されたバックアップ実行時間に自動バックアップが行われます。バックアップ実行時間を指定しない場合は、毎日負荷が集中しない任意の時点で自動バックアップを実行します。バックアップ実行時間を指定すると、指定された時刻から15分の間に自動バックアップを実行します。自動バックアップは最大30日まで保管できます。バックアップ保管期間をなしに設定すると、自動バックアップが無効になり、保存されたすべての自動バックアップファイルがバックアップストレージから削除されます。自動バックアップが無効になると、バックアップ保管期間中の任意の時点へ復元ができなくなりますが、手動バックアップを利用して特定時刻への復元は可能です。

> [注意]
> 自動バックアップを有効にした場合、データベースの復旧モデルは`全体(Full)`にする必要があります。
> `単純(Simple)`および`大量ログ(Bulk logged)`モデルを使用する場合、強制的に`全体(Full)`復旧モデルに変更すると同時に全体バックアップが再び行われます。

### 手動バックアップ

自動バックアップが有効になっているかどうかに関係なく、任意の時刻に手動でバックアップを実行できます。手動でバックアップ作成時、名前を入力する必要があります。命名ルールは次のとおりです。

* バックアップ名はリージョンごとに固有の名前にする必要があります。
* バックアップ名は4～100文字まで入力可能で、英数字、(-)(_)(.)のみ使用可能です。
* バックアップ名の最初の文字は英字のみ使用できます。

## 復元

RDS for MS-SQLは、バックアップファイルを利用してバックアップされた瞬間に復元したり、復元したい任意の時点を選択して復元を行うことができます。復元を行うと、既存DBインスタンスと関係がない新規DBインスタンスが作成されます。復元されたDBインスタンスはデータベースのみ復元されるため、パラメータグループとセキュリティグループを新たに設定する必要があります。新しいパラメータグループを設定することはできますが、バックアップした時のパラメータグループを使用して復元することを推奨します。

### バックアップを利用した復元

手動または自動バックアップを利用してDBインスタンスを復元できます。復元にかかる時間はバックアップのサイズによって異なり、数分から数十分かかります。
復元するDBインスタンスのタイプとパラメータグループは、バックアップした時点のDBインスタンスと同じ設定にすることを推奨します。

> [注意]
> DBインスタンスに複数のデータベースが存在し、各データベースのサイズが大きい場合、バックアップ実行時刻に差が生じる場合があります。
> データベースごとに順次バックアップが行われるため、バックアップを実行した時刻にすべてのデータベースが復元されることを保障しません。 

### バックアップ保管期間中の任意の時点に復元

DBインスタンスの自動バックアップが有効になっている場合、保管期間中の任意の時点へ復元可能です。時点復元を行うには別途、ログバックアップが必要です。RDS for MS-SQLは、5分毎に自動的にログバックアップを実行した後、バックアップストレージに保存します。自動バックアップを有効にした時刻から、最後にログバックアップを保存した時点まで、復元可能です。
自動バックアップが有効になっている場合、5分周期でユーザーが作成したデータベースを検知して全体バックアップを別途行います。したがってデータベース作成直後の時点に復元する時、新規で作成したデータベースは正常に復元されません。別途の作業を行っていない安定的なDBインスタンスを基準に、作成時点から少なくとも5分以上経過した時点を選択する必要があります。   

## オブジェクトストレージを利用したバックアップのエクスポートおよびインポート

DBインスタンスのバックアップをユーザーオブジェクトストレージにバックアップしたり、ユーザーオブジェクトストレージにあるバックアップファイルをDBインスタンスに復元できます。

### オブジェクトストレージにバックアップ

バックアップが完了したバックアップファイルをエクスポートしたり、バックアップと同時にバックアップファイルをエクスポートできます。バックアップファイルはデータベースごとにエクスポートしますが、オブジェクトストレージのREST APIを使用できるように設定されたすべてのTOAST Cloudのオブジェクトストレージにエクスポートできます。
バックアップと同時にバックアップファイルをエクスポートする時は全体バックアップだけでなく、差分バックアップもサポートします。

バックアップをオブジェクトストレージにエクスポートするには、まずバックアップファイルが保存されたコンテナを作成する必要があります。コンテナ作成後はWebコンソールの**オブジェクトストレージへバックアップ**機能を利用してエクスポートできます。
バックアップファイルのサイズが1GBを超えるとマルチパート形式でアップロードされます。

### オブジェクトストレージにあるバックアップで復元

互換可能なMicrosoft SQL Serverのバックアップファイルのみ、オブジェクトストレージを利用してRDS for MS-SQLのDBインスタンスに復元できます。
REST APIを使用できるように設定されたTOAST Cloudのオブジェクトストレージに外部からバックアップしたファイルをアップロードした後、Webコンソールの**オブジェクトストレージにあるバックアップで復元**機能を利用して復元できます。

復元するバックアップファイルが5GBを超える場合は、マルチパート形式でアップロードする必要があります。詳しい使用方法は[マルチパートアップロード](https://docs.toast.com/ko/Storage/Object%20Storage/ko/api-guide/#_53)を参照してください。
復元はデータベースごとに行われ、すでに作成されたDBインスタンスに復元できます。DBインスタンスのストレージに十分な空きがない場合は復元に失敗する場合があります。

> [注意]
> `master`データベースを復元しないため、復元されたデータベースのユーザー接続情報はDBインスタンス作成時に入力したユーザーのみ接続できるように修正されます。
高可用性DBインスタンスに復元する場合、 `復元するかどうか`を「はい」で復元する瞬間、データベースの復元が完了すると同時に高可用性構成が始まります。`復元するかどうか`を`いいえ`で復元する途中でフェイルオーバーが発生すると、復元中のデータベースは削除されます。 
